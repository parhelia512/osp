From 66cb95ad98247b1ea8073986847fc4d9a3a9b783 Mon Sep 17 00:00:00 2001
From: Juliusz Sosinowicz <juliusz@wolfssl.com>
Date: Fri, 20 Feb 2026 19:02:02 +0100
Subject: [PATCH] Patch for wolfSSL

---
 configure.ac                      | 60 ++++++++++++++++---------------
 include/ntp_md5.h                 |  8 +++--
 libntp/lib/isc/include/isc/util.h |  2 +-
 libntp/lib/isc/lib.c              |  2 +-
 libntp/lib/isc/sockaddr.c         |  6 ++--
 libntp/ssl_init.c                 |  4 ---
 ntpd/ntp_crypto.c                 | 11 +++++-
 sntp/configure.ac                 |  2 ++
 util/ntp-keygen.c                 | 22 ++++++++++--
 9 files changed, 74 insertions(+), 43 deletions(-)

diff --git a/configure.ac b/configure.ac
index aef7053..de9e789 100644
--- a/configure.ac
+++ b/configure.ac
@@ -3008,34 +3008,38 @@ case "$ntp_libparse" in
 esac
 AC_MSG_RESULT([$ans])
 
-# if we have crypto, by default Autokey is enabled
-AC_ARG_ENABLE(
-    [autokey],
-    AS_HELP_STRING(
-	[--enable-autokey],
-	[+ support NTP Autokey protocol]
-	),
-    [ntp_autokey=$enableval],
-    [ntp_autokey=$ntp_openssl]
-)
-case "$ntp_autokey" in
- no)
-    ;;
- *)
-    case "$ntp_openssl" in
-     no)
-	AC_MSG_WARN([Disabling Autokey, crypto unavailable.])
-	ntp_autokey=no
-	;;
-     *)
-	AC_DEFINE([AUTOKEY], [1], [Support NTP Autokey protocol?])
-	ntp_autokey=yes
-	;;
-    esac
-    ;;
-esac
-AC_MSG_CHECKING([if NTP Autokey protocol will be supported])
-AC_MSG_RESULT([$ntp_autokey])
+NTP_WOLFSSL
+
+if test $USE_WOLFSSL = no; then
+	# if we have crypto, by default Autokey is enabled
+	AC_ARG_ENABLE(
+	    [autokey],
+	    AS_HELP_STRING(
+		[--enable-autokey],
+		[+ support NTP Autokey protocol]
+		),
+	    [ntp_autokey=$enableval],
+	    [ntp_autokey=$ntp_openssl]
+	)
+	case "$ntp_autokey" in
+	 no)
+	    ;;
+	 *)
+	    case "$ntp_openssl" in
+	     no)
+		AC_MSG_WARN([Disabling Autokey, crypto unavailable.])
+		ntp_autokey=no
+		;;
+	     *)
+		AC_DEFINE([AUTOKEY], [1], [Support NTP Autokey protocol?])
+		ntp_autokey=yes
+		;;
+	    esac
+	    ;;
+	esac
+	AC_MSG_CHECKING([if NTP Autokey protocol will be supported])
+	AC_MSG_RESULT([$ntp_autokey])
+fi
 
 AC_SUBST([MAKE_CHECK_LAYOUT])
 AC_MSG_CHECKING([if we want to run check-layout])
diff --git a/include/ntp_md5.h b/include/ntp_md5.h
index 22caff3..0e12bf5 100644
--- a/include/ntp_md5.h
+++ b/include/ntp_md5.h
@@ -7,6 +7,7 @@
 #define NTP_MD5_H
 
 /* Use the system MD5 or fall back on libisc's */
+# ifndef WITH_WOLFSSL
 # if defined HAVE_MD5_H && defined HAVE_MD5INIT
 #  include <md5.h>
 # else
@@ -17,18 +18,19 @@
 #  define MD5Update(c, p, s)	isc_md5_update(c, (const void *)p, s)
 #  define MD5Final(d, c)	isc_md5_final((c), (d))	/* swapped */
 # endif
+# endif /* !WITH_WOLFSSL */
 
 # define KEY_TYPE_MD5			NID_md5
 
 #ifdef OPENSSL
 # include <openssl/evp.h>
 # include "libssl_compat.h"
-# ifdef HAVE_OPENSSL_CMAC_H
+# if defined(HAVE_OPENSSL_CMAC_H) || (defined(WITH_WOLFSSL) && defined(WOLFSSL_CMAC))
 #  include <openssl/cmac.h>
 #  define CMAC                  "AES128CMAC"
 #  define AES_128_KEY_SIZE      16
-# endif /*HAVE_OPENSSL_CMAC_H*/
-#else	/* !OPENSSL follows */
+# endif /* HAVE_OPENSSL_CMAC_H || (WITH_WOLFSSL && WOLFSSL_CMAC) */
+#else /* !OPENSSL follows */
 /*
  * Provide OpenSSL-alike MD5 API if we're not using OpenSSL
  */
diff --git a/libntp/lib/isc/include/isc/util.h b/libntp/lib/isc/include/isc/util.h
index 670b28b..96b35c0 100644
--- a/libntp/lib/isc/include/isc/util.h
+++ b/libntp/lib/isc/include/isc/util.h
@@ -226,7 +226,7 @@
 /*% Unexpected Error */
 #define UNEXPECTED_ERROR		isc_error_unexpected
 /*% Fatal Error */
-#define FATAL_ERROR			isc_error_fatal
+#define NTP_FATAL_ERROR			isc_error_fatal
 /*% Runtime Check */
 #define RUNTIME_CHECK(cond)		ISC_ERROR_RUNTIMECHECK(cond)
 
diff --git a/libntp/lib/isc/lib.c b/libntp/lib/isc/lib.c
index a505425..2707ff9 100644
--- a/libntp/lib/isc/lib.c
+++ b/libntp/lib/isc/lib.c
@@ -68,7 +68,7 @@ isc_lib_initmsgcat(void) {
 	result = isc_once_do(&msgcat_once, open_msgcat);
 	if (result != ISC_R_SUCCESS) {
 		/*
-		 * Normally we'd use RUNTIME_CHECK() or FATAL_ERROR(), but
+		 * Normally we'd use RUNTIME_CHECK() or NTP_FATAL_ERROR(), but
 		 * we can't do that here, since they might call us!
 		 * (Note that the catalog might be open anyway, so we might
 		 * as well try to  provide an internationalized message.)
diff --git a/libntp/lib/isc/sockaddr.c b/libntp/lib/isc/sockaddr.c
index c6932d4..b7184f0 100644
--- a/libntp/lib/isc/sockaddr.c
+++ b/libntp/lib/isc/sockaddr.c
@@ -360,7 +360,7 @@ isc_sockaddr_pf(const isc_sockaddr_t *sockaddr) {
 	case AF_INET6:
 		return (PF_INET6);
 	default:
-		FATAL_ERROR(__FILE__, __LINE__,
+		NTP_FATAL_ERROR(__FILE__, __LINE__,
 			    isc_msgcat_get(isc_msgcat, ISC_MSGSET_SOCKADDR,
 					   ISC_MSG_UNKNOWNFAMILY,
 					   "unknown address family: %d"),
@@ -411,7 +411,7 @@ isc_sockaddr_setport(isc_sockaddr_t *sockaddr, in_port_t port) {
 		sockaddr->type.sin6.sin6_port = htons(port);
 		break;
 	default:
-		FATAL_ERROR(__FILE__, __LINE__,
+		NTP_FATAL_ERROR(__FILE__, __LINE__,
 			    "%s: %d",
 			    isc_msgcat_get(isc_msgcat, ISC_MSGSET_SOCKADDR,
 					   ISC_MSG_UNKNOWNFAMILY,
@@ -432,7 +432,7 @@ isc_sockaddr_getport(const isc_sockaddr_t *sockaddr) {
 		port = ntohs(sockaddr->type.sin6.sin6_port);
 		break;
 	default:
-		FATAL_ERROR(__FILE__, __LINE__,
+		NTP_FATAL_ERROR(__FILE__, __LINE__,
 			    "%s: %d",
 			    isc_msgcat_get(isc_msgcat, ISC_MSGSET_SOCKADDR,
 					   ISC_MSG_UNKNOWNFAMILY,
diff --git a/libntp/ssl_init.c b/libntp/ssl_init.c
index 6de8a0b..7756b79 100644
--- a/libntp/ssl_init.c
+++ b/libntp/ssl_init.c
@@ -134,10 +134,6 @@ keytype_from_text(
 	key_type = 0;
 #endif
 
-	if (!key_type && 'm' == tolower((unsigned char)text[0])) {
-		key_type = NID_md5;
-	}
-
 	if (!key_type) {
 		return 0;
 	}
diff --git a/ntpd/ntp_crypto.c b/ntpd/ntp_crypto.c
index 38a62fd..6b44637 100644
--- a/ntpd/ntp_crypto.c
+++ b/ntpd/ntp_crypto.c
@@ -2956,7 +2956,11 @@ crypto_bob3(
 	while (1) {
 		BN_rand(k, BN_num_bits(q), 0, 0);
 		BN_mod(k, k, q, bctx);
+	#ifdef WITH_WOLFSSL
+		BN_gcd(u, k, (BIGNUM*)q, bctx);
+	#else
 		BN_gcd(u, k, q, bctx);
+	#endif
 		if (BN_is_one(u))
 			break;
 	}
@@ -3551,8 +3555,13 @@ cert_parse(
 		 */
 		case NID_subject_key_identifier:
 			data = X509_EXTENSION_get_data(ext);
+		#ifdef WITH_WOLFSSL
+			ret->grpkey = BN_bin2bn((const unsigned char*)&data->data[2],
+				data->length - 2, NULL);
+		#else
 			ret->grpkey = BN_bin2bn(&data->data[2],
-			    data->length - 2, NULL);
+				data->length - 2, NULL);
+		#endif
 			/* fall through */
 		default:
 			DPRINTF(1, ("cert_parse: %s\n",
diff --git a/sntp/configure.ac b/sntp/configure.ac
index 4fb182b..9213f62 100644
--- a/sntp/configure.ac
+++ b/sntp/configure.ac
@@ -120,6 +120,8 @@ NTP_FACILITYNAMES
 # Checks for typedefs, structures, and compiler characteristics.
 AC_HEADER_STDBOOL
 
+NTP_WOLFSSL
+
 NTP_IPV6
 
 ###
diff --git a/util/ntp-keygen.c b/util/ntp-keygen.c
index c9c0ff9..de79f48 100644
--- a/util/ntp-keygen.c
+++ b/util/ntp-keygen.c
@@ -2210,20 +2210,29 @@ genRsaKeyPair(
 	)
 {
 	RSA *		rsa = RSA_new();
-	BN_GENCB *	gcb = BN_GENCB_new();
 	BIGNUM *	bne = BN_new();
+#ifndef WITH_WOLFSSL
+	BN_GENCB *	gcb = BN_GENCB_new();
 	
 	if (gcb)
 		BN_GENCB_set_old(gcb, cb, what);
+#endif
 	if (bne)
 		BN_set_word(bne, 65537);
+#ifdef WITH_WOLFSSL
+	if (!(rsa && bne && RSA_generate_key_ex(
+		      rsa, bits, bne, NULL)))
+#else
 	if (!(rsa && gcb && bne && RSA_generate_key_ex(
 		      rsa, bits, bne, gcb)))
+#endif
 	{
 		RSA_free(rsa);
 		rsa = NULL;
 	}
+#ifndef WITH_WOLFSSL
 	BN_GENCB_free(gcb);
+#endif
 	BN_free(bne);
 	return rsa;
 }
@@ -2236,19 +2245,28 @@ genDsaParams(
 {
 	
 	DSA *		dsa = DSA_new();
-	BN_GENCB *	gcb = BN_GENCB_new();
 	u_char		seed[20];
+#ifndef WITH_WOLFSSL
+	BN_GENCB *	gcb = BN_GENCB_new();
 	
 	if (gcb)
 		BN_GENCB_set_old(gcb, cb, what);
+#endif
 	RAND_bytes(seed, sizeof(seed));
+#ifdef WITH_WOLFSSL
+	if (!(dsa && DSA_generate_parameters_ex(
+		      dsa, bits, seed, sizeof(seed), NULL, NULL, NULL)))
+#else
 	if (!(dsa && gcb && DSA_generate_parameters_ex(
 		      dsa, bits, seed, sizeof(seed), NULL, NULL, gcb)))
+#endif
 	{
 		DSA_free(dsa);
 		dsa = NULL;
 	}
+#ifndef WITH_WOLFSSL
 	BN_GENCB_free(gcb);
+#endif
 	return dsa;
 }
 
-- 
2.43.0

